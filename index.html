<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>割り勘ソムリエ - スマート割り勘アプリ</title>
<link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px; height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f1f1; border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #888; border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #555;
        }
        .screen {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .screen.hidden {
            opacity: 0; transform: scale(0.95); pointer-events: none; position: absolute; width: 100%;
        }
        .btn-primary {
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #9ca3af; cursor: not-allowed;
        }
        .form-input:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); border-color: #2563eb;
        }
        .delimiter-btn.active {
            background-color: #3b82f6; color: white;
        }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="relative max-w-lg mx-auto bg-white shadow-lg rounded-lg my-4 sm:my-8 overflow-hidden">

        <!-- ===== 画面0: ホーム画面 ===== -->
        <div id="home-screen" class="screen p-6 sm:p-8">
             <header class="text-center mb-8 relative">
               <img src="logo.png" alt="割り勘ソムリエ ロゴ" class="mx-auto mb-6 h-28 w-28 rounded-lg">
                <h1 class="text-3xl font-bold text-gray-900">割り勘ソムリエ</h1>
                <p class="text-gray-500 mt-2">スマート割り勘アプリ</p>
                <p class="text-sm text-gray-400 mt-2">はしご酒の複雑な割り勘を、誰でも簡単・正確に。</p>
                <button id="share-app-btn" class="absolute top-0 right-0 text-gray-500 hover:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                    </svg>
                </button>
            </header>
            <div>
                <button id="new-settlement-btn" class="btn-primary w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">新しく清算を始める</button>
                <button id="how-to-use-btn" class="w-full text-center text-blue-600 hover:underline mt-4 text-sm">使い方を見る</button>
                
                <div class="mt-8 grid grid-cols-2 gap-4">
                    <button id="manage-tags-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 text-sm">タグを管理する</button>
                    <button id="history-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 text-sm">過去の清算を見る</button>
                </div>
            </div>
        </div>

        <!-- ===== 画面1: 初期設定画面 ===== -->
        <div id="setup-screen" class="screen hidden p-6 sm:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">新しい清算</h1>
            </header>
            <div class="space-y-6">
                <div>
                    <label for="eventDate" class="block text-sm font-medium text-gray-700 mb-1">イベント日</label>
                    <input type="date" id="eventDate" class="form-input w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="eventName" class="block text-sm font-medium text-gray-700 mb-1">イベント名</label>
                    <input type="text" id="eventName" class="form-input w-full border-gray-300 rounded-md shadow-sm" placeholder="例: 渋谷飲み会">
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="members" class="block text-sm font-medium text-gray-700">参加メンバー</label>
                        <div class="flex border border-gray-300 rounded-md text-xs">
                            <button id="delimiter-zenkaku" class="delimiter-btn px-2 py-1 rounded-l-md">、区切り</button>
                            <button id="delimiter-hankaku" class="delimiter-btn px-2 py-1 rounded-r-md">, 区切り</button>
                        </div>
                    </div>
                    <textarea id="members" rows="3" class="form-input w-full border-gray-300 rounded-md shadow-sm" placeholder="例: 田中、鈴木、佐藤"></textarea>
                </div>
                <button id="start-btn" class="btn-primary w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">精算を開始する</button>
                <button id="back-to-home-btn-from-setup" class="w-full text-center text-sm text-gray-500 hover:underline mt-2">ホームに戻る</button>
            </div>
        </div>
        
        <!-- ===== 履歴画面 ===== -->
        <div id="history-screen" class="screen hidden p-6 sm:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">過去の清算</h1>
            </header>
            <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar"></div>
            <button id="back-to-home-btn-from-history" class="w-full text-center text-sm text-gray-500 hover:underline mt-6">ホームに戻る</button>
        </div>
        
        <!-- ===== タグ管理画面 ===== -->
        <div id="tag-manager-screen" class="screen hidden p-6 sm:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">タグの管理</h1>
            </header>
            <div id="tag-list" class="space-y-3 mb-6"></div>
            <div class="mt-6">
                <button id="show-add-tag-modal-btn" class="btn-primary w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg">新しいタグを追加</button>
            </div>
            <button id="back-to-home-btn-from-tags" class="w-full text-center text-sm text-gray-500 hover:underline mt-6">ホームに戻る</button>
        </div>

        <!-- ===== イベント精算画面 ===== -->
        <div id="event-screen" class="screen hidden">
            <header class="bg-gray-100 p-4 border-b flex items-center justify-between">
                <button id="back-to-setup-btn" class="text-sm text-blue-600 hover:underline">＜ 設定に戻る</button>
                <h2 id="event-title" class="text-xl font-bold text-gray-900 text-center"></h2>
                <div class="w-24"></div>
            </header>
            <div class="border-b border-gray-200">
                <nav id="tabs" class="flex items-center space-x-2 p-2 overflow-x-auto custom-scrollbar"></nav>
            </div>
            <div id="stop-details" class="p-6"></div>
            <div class="p-6 bg-gray-50 border-t">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-900">総合精算テーブル</h3>
                    <button id="screenshot-btn" class="text-sm text-blue-600 hover:underline flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        画像で保存
                    </button>
                </div>
                <div class="overflow-x-auto custom-scrollbar rounded-lg border">
                    <table id="summary-table" class="w-full text-sm text-left text-gray-500">
                        <thead id="summary-table-head" class="text-xs text-gray-700 uppercase bg-gray-100"></thead>
                        <tbody id="summary-table-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-6 border-t">
                <button id="finalize-btn" class="btn-primary w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">精算を確定する</button>
            </div>
        </div>
        
        <!-- ===== 最終精算画面 ===== -->
        <div id="summary-screen" class="screen hidden p-6 sm:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">最終精算</h1>
            </header>
            <div class="bg-white p-6 rounded-lg shadow border space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-900">最適な精算方法</h3>
                    <ul id="settlement-steps" class="space-y-2"></ul>
                </div>
            </div>
            <div class="mt-8 space-y-4">
                 <button id="save-settlement-btn" class="btn-primary w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">この内容を保存</button>
                 <button id="copy-btn" class="btn-primary w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">グループ連絡用にコピー</button>
                 <button id="back-to-edit-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">編集に戻る</button>
                 <button id="back-to-home-btn-from-summary" class="w-full text-center text-sm text-gray-500 hover:underline mt-2">ホームに戻る</button>
            </div>
        </div>
        
        <!-- ===== 清算状況確認画面 ===== -->
        <div id="settlement-status-screen" class="screen hidden p-6 sm:p-8">
            <header class="text-center mb-8">
                <h1 id="settlement-status-title" class="text-2xl font-bold text-gray-900"></h1>
            </header>
            <div id="settlement-status-list" class="space-y-3"></div>
            <button id="back-to-history-btn" class="w-full text-center text-sm text-gray-500 hover:underline mt-6">履歴一覧に戻る</button>
        </div>

    </div>
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b"><h3 class="text-lg font-semibold">メッセージテンプレートを選択</h3></div>
            <div class="p-4">
                <div id="template-tabs" class="flex border-b mb-4">
                    <button data-template="company" class="template-tab-btn flex-1 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600">会社員用</button>
                    <button data-template="friends" class="template-tab-btn flex-1 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">友達用</button>
                </div>
                <div class="bg-gray-100 p-3 rounded-md h-64 overflow-y-auto custom-scrollbar border">
                    <pre id="message-preview" class="text-sm whitespace-pre-wrap break-words"></pre>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex gap-4">
                <button id="copy-confirm-btn" class="btn-primary flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">この内容でコピー</button>
                <button id="modal-close-btn" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">キャンセル</button>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-[-20px] transition-all duration-300 z-50"></div>
    
    <!-- ===== Error Modal ===== -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold text-red-600">入力内容をご確認ください</h3>
            </div>
            <div class="p-4">
                <ul id="error-list" class="list-disc list-inside text-gray-700 space-y-1"></ul>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button id="error-modal-close-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">閉じる</button>
            </div>
        </div>
    </div>

    <!-- ===== Tag Selection Modal ===== -->
    <div id="tag-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b">
                <h3 id="tag-selection-title" class="text-lg font-semibold">タグを選択</h3>
            </div>
            <div id="tag-selection-list" class="p-4 space-y-2 overflow-y-auto"></div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button id="tag-selection-close-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">決定</button>
            </div>
        </div>
    </div>

    <!-- ===== Add Tag Modal ===== -->
    <div id="add-tag-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold">新しいタグを追加</h3>
            </div>
            <div class="p-4 space-y-4">
                 <div>
                    <label for="modal-new-tag-name" class="block text-sm font-medium text-gray-700 mb-1">タグ名</label>
                    <input type="text" id="modal-new-tag-name" class="form-input w-full border-gray-300 rounded-md" placeholder="例: ドライバー">
                </div>
                <div>
                    <label for="modal-new-tag-rate" class="block text-sm font-medium text-gray-700 mb-1">掛率</label>
                    <input type="number" id="modal-new-tag-rate" class="form-input w-full border-gray-300 rounded-md" placeholder="例: 0.7">
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-4">
                 <button id="add-tag-cancel-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">キャンセル</button>
                 <button id="add-tag-confirm-btn" class="btn-primary bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">追加する</button>
            </div>
        </div>
    </div>
    
    <!-- ===== How to Use Modal ===== -->
    <div id="how-to-use-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">使い方ガイド</h3>
                <button id="how-to-use-close-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="how-to-use-steps" class="flex-1 flex overflow-x-auto snap-x snap-mandatory no-scrollbar">
                <!-- Step 1 -->
                <div class="flex-shrink-0 w-full snap-center p-6 flex flex-col text-center">
                    <div class="flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-40 w-40 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold mt-4 mb-2">ステップ1：イベントの作成</h4>
                    <p class="text-gray-600">イベント日、名前、参加メンバーを入力して「精算を開始する」をタップ！</p>
                </div>
                <!-- Step 2 -->
                <div class="flex-shrink-0 w-full snap-center p-6 flex flex-col text-center">
                    <div class="flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-40 w-40 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold mt-4 mb-2">ステップ2：会計の入力</h4>
                    <p class="text-gray-600">お店ごとの合計金額や立替者、参加者を設定し、負担率やタグで傾斜をつけます。</p>
                </div>
                <!-- Step 3 -->
                <div class="flex-shrink-0 w-full snap-center p-6 flex flex-col text-center">
                     <div class="flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-40 w-40 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold mt-4 mb-2">ステップ3：最適な精算</h4>
                    <p class="text-gray-600">「精算を確定」を押せば、最も送金回数が少ない最適な精算方法を自動で提案します！</p>
                </div>
                 <!-- Step 4 -->
                <div class="flex-shrink-0 w-full snap-center p-6 flex flex-col text-center">
                    <div class="flex-1 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-40 w-40 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold mt-4 mb-2">ステップ4：清算状況の管理</h4>
                    <p class="text-gray-600">保存した履歴から、誰の支払いが完了したかをチェックして管理。未払いの人にはリマインドも簡単です！</p>
                </div>
            </div>
            <div id="how-to-use-progress" class="p-4 flex justify-center items-center space-x-2"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = {};
            let tags = [];
            const screens = {
                home: document.getElementById('home-screen'),
                setup: document.getElementById('setup-screen'),
                history: document.getElementById('history-screen'),
                event: document.getElementById('event-screen'),
                summary: document.getElementById('summary-screen'),
                tagManager: document.getElementById('tag-manager-screen'),
                settlementStatus: document.getElementById('settlement-status-screen')
            };
            const startBtn = document.getElementById('start-btn');
            const eventDateInput = document.getElementById('eventDate');
            const eventNameInput = document.getElementById('eventName');
            const membersInput = document.getElementById('members');
            const delimiterZenkakuBtn = document.getElementById('delimiter-zenkaku');
            const delimiterHankakuBtn = document.getElementById('delimiter-hankaku');
            const templateModal = document.getElementById('template-modal');
            const toast = document.getElementById('toast');
            let reminderContext = null;

            function switchScreen(screenName) {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
            }

            function resetState() {
                state = {
                    id: Date.now(),
                    eventDate: '',
                    eventName: '',
                    allMembers: [],
                    stops: [],
                    activeStopIndex: 0,
                    delimiter: '、',
                    settlementStatus: {}
                };
                eventDateInput.value = new Date().toISOString().slice(0, 10);
                eventNameInput.value = '';
                membersInput.value = '';
                setDelimiter('、');
            }
            
            function setDelimiter(delimiter) {
                state.delimiter = delimiter;
                delimiterZenkakuBtn.classList.toggle('active', delimiter === '、');
                delimiterHankakuBtn.classList.toggle('active', delimiter === ',');
                membersInput.placeholder = `例: 田中${delimiter}鈴木${delimiter}佐藤`;
            }

            function startEvent() {
                const eventDate = eventDateInput.value;
                const eventName = eventNameInput.value.trim();
                const members = membersInput.value.trim().split(state.delimiter).map(m => m.trim()).filter(Boolean);

                const errors = [];
                if (!eventDate) errors.push("イベント日を入力してください。");
                if (!eventName) errors.push("イベント名を入力してください。");
                if (members.length < 2) errors.push("参加メンバーを2名以上、形式に沿って入力してください。");

                if (errors.length > 0) {
                    const errorList = document.getElementById('error-list');
                    errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
                    document.getElementById('error-modal').classList.remove('hidden');
                    return;
                }
                
                state.eventDate = eventDate;
                state.eventName = eventName;
                state.allMembers = members;
                state.stops = [];
                addNewStop();
                
                document.getElementById('event-title').textContent = `${state.eventDate} ${state.eventName}`;
                switchScreen('event');
            }
            
            function addNewStop() {
                const newStop = { name: `${state.stops.length + 1}軒目`, totalAmount: 0, participants: {}, payer: state.allMembers[0] };
                state.allMembers.forEach(member => {
                    newStop.participants[member] = { isParticipating: true, burdenRate: 100, tags: [] };
                });
                state.stops.push(newStop);
                state.activeStopIndex = state.stops.length - 1;
                render();
            }

            function deleteStop(indexToDelete) {
                if (state.stops.length <= 1) { alert('最後の会計は削除できません。'); return; }
                state.stops.splice(indexToDelete, 1);
                state.stops.forEach((stop, index) => { stop.name = `${index + 1}軒目`; });
                state.activeStopIndex = Math.max(0, state.activeStopIndex - 1);
                render();
            }
            
            function render() {
                renderTabs();
                renderStopDetails();
                renderSummaryTable();
            }

            function renderTabs() {
                const tabsContainer = document.getElementById('tabs');
                tabsContainer.innerHTML = '';
                state.stops.forEach((stop, index) => {
                    const isActive = index === state.activeStopIndex;
                    const tabWrapper = document.createElement('div');
                    tabWrapper.className = `flex items-center rounded-md ${isActive ? 'bg-blue-600 text-white shadow' : 'bg-gray-200 text-gray-700'}`;
                    const tab = document.createElement('button');
                    tab.className = `px-4 py-2 text-sm font-medium whitespace-nowrap rounded-l-md ${isActive ? '' : 'hover:bg-gray-300'}`;
                    tab.textContent = stop.name;
                    tab.onclick = () => { state.activeStopIndex = index; render(); };
                    tabWrapper.appendChild(tab);
                    if (state.stops.length > 1) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.className = `px-2 py-2 text-sm font-bold rounded-r-md ${isActive ? 'hover:bg-blue-700' : 'hover:bg-gray-300'}`;
                        deleteBtn.onclick = () => deleteStop(index);
                        tabWrapper.appendChild(deleteBtn);
                    }
                    tabsContainer.appendChild(tabWrapper);
                });
                const addTab = document.createElement('button');
                addTab.className = 'px-4 py-2 text-sm font-medium rounded-md bg-green-100 text-green-800 hover:bg-green-200';
                addTab.textContent = '＋ 会計を追加';
                addTab.onclick = addNewStop;
                tabsContainer.appendChild(addTab);
            }

            function renderStopDetails() {
                const stop = state.stops[state.activeStopIndex];
                if (!stop) return;
                const stopDetailsContainer = document.getElementById('stop-details');
                stopDetailsContainer.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">会計名</label><input type="text" value="${stop.name}" onchange="updateStopName(event.target.value)" class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="block text-sm font-medium text-gray-700">立替者</label><select onchange="updatePayer(event.target.value)" class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm">${state.allMembers.map(m => `<option value="${m}" ${m === stop.payer ? 'selected' : ''}>${m}</option>`).join('')}</select></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700">合計金額 (円)</label><input type="number" value="${stop.totalAmount || ''}" onchange="updateTotalAmount(event.target.value)" placeholder="例: 30000" class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                        <div><h4 class="text-md font-semibold mb-2 text-gray-800">参加メンバー</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${state.allMembers.map(member => `<label class="flex items-center space-x-2 p-2 rounded-md bg-gray-100 cursor-pointer hover:bg-gray-200"><input type="checkbox" ${stop.participants[member]?.isParticipating ? 'checked' : ''} onchange="toggleParticipant('${member}', this.checked)" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span class="text-sm">${member}</span></label>`).join('')}</div></div>
                        <div><h4 class="text-md font-semibold mb-2 text-gray-800">負担率の調整</h4><div class="space-y-3">
                            ${Object.entries(stop.participants).filter(([_, p]) => p.isParticipating).map(([member, details]) => `
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <div class="grid grid-cols-3 gap-2 items-center">
                                        <span class="text-sm font-medium truncate">${member}</span>
                                        <div class="flex items-center justify-center">
                                            <button onclick="updateBurdenRate('${member}', -10)" class="px-2 py-1 bg-gray-200 rounded-l-md hover:bg-gray-300">-</button>
                                            <input type="number" value="${details.burdenRate}" onchange="updateBurdenRate('${member}', event.target.value, true)" class="w-16 text-center border-y border-gray-300">
                                            <button onclick="updateBurdenRate('${member}', 10)" class="px-2 py-1 bg-gray-200 rounded-r-md hover:bg-gray-300">+</button>
                                        </div>
                                        <span id="amount-${state.activeStopIndex}-${member}" class="text-right text-sm text-gray-600"></span>
                                    </div>
                                    <div class="mt-2">
                                        <div id="tags-for-${member}-${state.activeStopIndex}" class="flex flex-wrap gap-1 items-center">
                                            ${(details.tags || []).map(tagName => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full inline-flex items-center">${tagName}<button onclick="removeTagFromMember('${member}', '${tagName}')" class="ml-1.5 -mr-1 text-blue-500 hover:text-blue-800 leading-none">&times;</button></span>`).join('')}
                                        </div>
                                        <button onclick="openTagSelectionModal('${member}')" class="text-xs text-blue-600 hover:underline mt-1">+ タグ付与</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div></div>
                    </div>`;
            }

            function renderSummaryTable() {
                document.getElementById('summary-table-head').innerHTML = `<tr><th scope="col" class="px-4 py-3">名前</th>${state.stops.map(stop => `<th scope="col" class="px-4 py-3 text-right">${stop.name}</th>`).join('')}<th scope="col" class="px-4 py-3 text-right font-bold">合計負担額</th><th scope="col" class="px-4 py-3 text-right font-bold">合計立替額</th><th class="px-4 py-3 text-right font-bold">メモ</th></tr>`;
                document.getElementById('summary-table-body').innerHTML = state.allMembers.map(member => `
                    <tr class="border-b hover:bg-gray-50">
                        <th scope="row" class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${member}</th>
                        ${state.stops.map((_, stopIndex) => `<td id="summary-${stopIndex}-${member}" class="px-4 py-3 text-right"></td>`).join('')}
                        <td id="summary-total-burden-${member}" class="px-4 py-3 text-right font-bold text-gray-900"></td>
                        <td id="summary-total-paid-${member}" class="px-4 py-3 text-right font-bold text-blue-600"></td>
                        <td id="summary-memo-${member}" class="px-4 py-3 text-xs text-gray-500"></td>
                    </tr>`).join('');
                calculateAndRenderAll();
            }

            function calculateAndRenderAll() {
                const memberTotals = Object.fromEntries(state.allMembers.map(m => [m, { burden: 0, paid: 0 }]));
                state.stops.forEach((stop, stopIndex) => {
                    if (stop.payer) {
                        memberTotals[stop.payer].paid += Number(stop.totalAmount);
                    }
                    const participatingMembers = Object.entries(stop.participants).filter(([_, p]) => p.isParticipating);
                    const totalBurdenUnits = participatingMembers.reduce((sum, [member, p]) => {
                        const tagMultiplier = (p.tags || []).reduce((acc, tagName) => {
                            const tag = tags.find(t => t.name === tagName);
                            return acc * (tag ? tag.rate : 1);
                        }, 1);
                        return sum + (p.burdenRate * tagMultiplier);
                    }, 0);

                    state.allMembers.forEach(member => {
                        let cost = 0;
                        if (stop.participants[member]?.isParticipating && stop.totalAmount > 0 && totalBurdenUnits > 0) {
                            const p = stop.participants[member];
                            const tagMultiplier = (p.tags || []).reduce((acc, tagName) => {
                                const tag = tags.find(t => t.name === tagName);
                                return acc * (tag ? tag.rate : 1);
                            }, 1);
                            cost = (stop.totalAmount * (p.burdenRate * tagMultiplier)) / totalBurdenUnits;
                        }
                        memberTotals[member].burden += cost;
                        const detailAmountEl = document.getElementById(`amount-${stopIndex}-${member}`);
                        if (detailAmountEl) detailAmountEl.textContent = `${Math.round(cost).toLocaleString()}円`;
                        const summaryCellEl = document.getElementById(`summary-${stopIndex}-${member}`);
                        if (summaryCellEl) summaryCellEl.textContent = stop.participants[member]?.isParticipating ? Math.round(cost).toLocaleString() : '-';
                    });
                });
                state.allMembers.forEach(member => {
                    document.getElementById(`summary-total-burden-${member}`).textContent = `${Math.round(memberTotals[member].burden).toLocaleString()}`;
                    document.getElementById(`summary-total-paid-${member}`).textContent = `${Math.round(memberTotals[member].paid).toLocaleString()}`;
                    
                    const memoParts = [];
                    state.stops.forEach((stop) => {
                        const p = stop.participants[member];
                        if (p && p.isParticipating && p.tags && p.tags.length > 0) {
                            memoParts.push(`${stop.name}:${p.tags.join('､')}`);
                        }
                    });
                    const memoEl = document.getElementById(`summary-memo-${member}`);
                    if (memoEl) memoEl.textContent = memoParts.join(' ');
                });
            }
            
            window.updateStopName = (name) => { state.stops[state.activeStopIndex].name = name; render(); };
            window.updateTotalAmount = (amount) => { state.stops[state.activeStopIndex].totalAmount = Number(amount); render(); };
            window.updatePayer = (payer) => { state.stops[state.activeStopIndex].payer = payer; render(); };
            window.toggleParticipant = (member, isParticipating) => { state.stops[state.activeStopIndex].participants[member].isParticipating = isParticipating; render(); };
            window.updateBurdenRate = (member, value, isDirectInput = false) => {
                const currentRate = state.stops[state.activeStopIndex].participants[member].burdenRate;
                let newRate = isDirectInput ? Number(value) : currentRate + value;
                state.stops[state.activeStopIndex].participants[member].burdenRate = Math.max(0, newRate);
                render();
            };
            window.removeTagFromMember = (member, tagName) => {
                const participant = state.stops[state.activeStopIndex].participants[member];
                if (participant && participant.tags) {
                    participant.tags = participant.tags.filter(t => t !== tagName);
                    render();
                }
            };

            function showFinalSummary() {
                switchScreen('summary');
                const settlementSteps = calculateOptimalSettlement();
                renderSettlementSteps(settlementSteps);
            }
            
            function calculateOptimalSettlement(settlementState = state) {
                const memberTotals = Object.fromEntries(settlementState.allMembers.map(m => [m, { burden: 0, paid: 0 }]));
                settlementState.stops.forEach(stop => {
                    if(stop.payer) memberTotals[stop.payer].paid += Number(stop.totalAmount);
                    const participatingMembers = Object.entries(stop.participants).filter(([_, p]) => p.isParticipating);
                    const totalBurdenUnits = participatingMembers.reduce((sum, [member, p]) => {
                        const tagMultiplier = (p.tags || []).reduce((acc, tagName) => {
                            const tag = tags.find(t => t.name === tagName);
                            return acc * (tag ? tag.rate : 1);
                        }, 1);
                        return sum + (p.burdenRate * tagMultiplier);
                    }, 0);

                    participatingMembers.forEach(([member, p]) => {
                        if (stop.totalAmount > 0 && totalBurdenUnits > 0) {
                            const tagMultiplier = (p.tags || []).reduce((acc, tagName) => {
                                const tag = tags.find(t => t.name === tagName);
                                return acc * (tag ? tag.rate : 1);
                            }, 1);
                           memberTotals[member].burden += (stop.totalAmount * (p.burdenRate * tagMultiplier)) / totalBurdenUnits;
                        }
                    });
                });

                const balances = settlementState.allMembers.map(m => ({ name: m, balance: memberTotals[m].paid - memberTotals[m].burden }));
                const debtors = balances.filter(p => p.balance < 0).sort((a, b) => a.balance - b.balance);
                const creditors = balances.filter(p => p.balance > 0).sort((a, b) => b.balance - a.balance);
                const transactions = [];

                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    const debtor = debtors[i];
                    const creditor = creditors[j];
                    const amount = Math.min(-debtor.balance, creditor.balance);

                    if (amount > 0.1) {
                        transactions.push({ from: debtor.name, to: creditor.name, amount: Math.round(amount) });
                        debtor.balance += amount;
                        creditor.balance -= amount;
                    }

                    if (Math.abs(debtor.balance) < 0.1) i++;
                    if (Math.abs(creditor.balance) < 0.1) j++;
                }
                return transactions;
            }

            function renderSettlementSteps(transactions) {
                const listEl = document.getElementById('settlement-steps');
                if (transactions.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-gray-600">精算は完了しています。</p>';
                    return;
                }
                listEl.innerHTML = transactions.map(t => `
                    <li class="flex items-center justify-center bg-gray-50 p-3 rounded-md text-center">
                        <span class="font-medium text-red-600">${t.from}</span>
                        <span class="mx-2 text-gray-500">が</span>
                        <span class="font-medium text-green-600">${t.to}</span>
                        <span class="mx-2 text-gray-500">に</span>
                        <span class="font-semibold text-lg text-gray-900">${t.amount.toLocaleString()}円</span>
                        <span class="ml-2 text-gray-500">支払う</span>
                    </li>
                `).join('');
            }

            function selectTemplateTab(templateName) {
                document.querySelectorAll('.template-tab-btn').forEach(btn => {
                    btn.classList.toggle('border-blue-500', btn.dataset.template === templateName);
                    btn.classList.toggle('text-blue-600', btn.dataset.template === templateName);
                    btn.classList.toggle('border-transparent', btn.dataset.template !== templateName);
                    btn.classList.toggle('text-gray-500', btn.dataset.template !== templateName);
                });
                generateMessagePreview(templateName);
            }

            function generateMessagePreview(templateName) {
                let message = '';
                if (reminderContext) {
                    const { from, to, amount } = reminderContext;
                    if (templateName === 'company') {
                        message = `${to}さん\n\nお疲れ様です。\n先日お願いしておりました、${from}さんへの${amount.toLocaleString()}円のお支払いについて、ご確認をお願いできますでしょうか？\n\nよろしくお願いいたします。`;
                    } else {
                        message = `${to}さん、お疲れ様！\nこの間の飲み会の件で、${from}さんへの${amount.toLocaleString()}円の支払いを忘れてないかな？\n時間があるときによろしくね！🍻`;
                    }
                } else {
                    const transactions = calculateOptimalSettlement();
                    const totalPaid = state.stops.reduce((sum, s) => sum + Number(s.totalAmount), 0);
                    const summaryText = state.stops.map(s => `・${s.name} (${s.payer}立替): ${Number(s.totalAmount).toLocaleString()}円`).join('\n');
                    const settlementText = transactions.length > 0 ? transactions.map(t => `・${t.from} → ${t.to} に ${t.amount.toLocaleString()}円`).join('\n') : '精算は完了しています。';

                    if (templateName === 'company') {
                        message = `各位\n\nお疲れ様です。${state.eventDate}の${state.eventName}の件、精算が完了しましたのでご連絡します。\n\n◆精算サマリー\n${summaryText}\n合計: ${Math.round(totalPaid).toLocaleString()}円\n\n◆精算方法（敬称略）\n${settlementText}\n\n上記内容でのご対応をお願いいたします。`;
                    } else {
                        message = `みんなお疲れ！${state.eventDate}の${state.eventName}の精算だよ🍻\n\n【精算サマリー】\n${summaryText}\n合計: ${Math.round(totalPaid).toLocaleString()}円\n\n【精算方法】\n${settlementText}\n\nこれで精算よろしく！`;
                    }
                }
                document.getElementById('message-preview').textContent = message;
            }
            
            function copyMessageToClipboard() {
                const textToCopy = document.getElementById('message-preview').textContent;
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('コピーしました！');
                } catch (err) { console.error('コピーに失敗しました', err); }
                document.body.removeChild(textArea);
                templateModal.classList.add('hidden');
                reminderContext = null;
            }

            function takeScreenshot() {
                const table = document.getElementById('summary-table');
                const eventName = state.eventName || '精算表';
                table.style.backgroundColor = 'white';
                html2canvas(table, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${state.eventDate}_${eventName}_精算表.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    table.style.backgroundColor = '';
                    showToast('画像として保存しました！');
                });
            }
            
            function showToast(message) {
                toast.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-[-20px]'); }, 2000);
            }
            
            function saveSettlement() {
                const transactions = calculateOptimalSettlement();
                state.settlementStatus = state.settlementStatus || {};
                transactions.forEach(t => {
                    const key = `${t.from}->${t.to}`;
                    if (!(key in state.settlementStatus)) {
                       state.settlementStatus[key] = false;
                    }
                });

                const settlements = JSON.parse(localStorage.getItem('warikan-sommelier-history') || '[]');
                const index = settlements.findIndex(s => s.id === state.id);
                if (index > -1) settlements[index] = state; else settlements.push(state);
                localStorage.setItem('warikan-sommelier-history', JSON.stringify(settlements));
                showToast('清算内容を保存しました！');
            }
            
            function renderHistory() {
                const settlements = JSON.parse(localStorage.getItem('warikan-sommelier-history') || '[]');
                const historyList = document.getElementById('history-list');
                if (settlements.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-center">保存された清算はありません。</p>';
                    return;
                }
                historyList.innerHTML = '';
                settlements.sort((a, b) => b.id - a.id).forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-100 p-4 rounded-lg';
                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold">${s.eventDate} ${s.eventName}</p>
                                <p class="text-sm text-gray-600">${s.allMembers.join(', ')}</p>
                            </div>
                            <div>
                                <button onclick="viewSettlement(${s.id})" class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600">見る</button>
                                <button onclick="deleteSettlement(${s.id})" class="text-sm bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 ml-2">削除</button>
                            </div>
                        </div>
                        <button onclick="showSettlementStatus(${s.id})" class="mt-2 w-full text-sm bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600">清算状況を確認</button>
                    `;
                    historyList.appendChild(item);
                });
            }

            window.viewSettlement = (id) => {
                const settlements = JSON.parse(localStorage.getItem('warikan-sommelier-history') || '[]');
                const settlementToView = settlements.find(s => s.id === id);
                if (settlementToView) {
                    state = settlementToView;
                    eventDateInput.value = state.eventDate;
                    eventNameInput.value = state.eventName;
                    membersInput.value = state.allMembers.join(state.delimiter || '、');
                    setDelimiter(state.delimiter || '、');
                    document.getElementById('event-title').textContent = `${state.eventDate} ${state.eventName}`;
                    render();
                    switchScreen('event');
                }
            };
            
            window.deleteSettlement = (id) => {
                if (confirm('この清算履歴を削除しますか？')) {
                    let settlements = JSON.parse(localStorage.getItem('warikan-sommelier-history') || '[]');
                    settlements = settlements.filter(s => s.id !== id);
                    localStorage.setItem('warikan-sommelier-history', JSON.stringify(settlements));
                    renderHistory();
                }
            };
            
            async function shareApp() {
                const shareData = { title: '割り勘ソムリエ', text: 'はしご酒の複雑な割り勘を、誰でも簡単・正確に。', url: window.location.href };
                try {
                    if (navigator.share) await navigator.share(shareData);
                    else throw new Error('Web Share API not supported');
                } catch (err) {
                    const textArea = document.createElement("textarea");
                    textArea.value = `${shareData.text}\n${shareData.url}`;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try { document.execCommand('copy'); showToast('アプリの情報をコピーしました！'); }
                    catch (copyErr) { alert('共有に失敗しました。'); }
                    document.body.removeChild(textArea);
                }
            }

            // --- Tag Functions ---
            function loadTags() {
                const savedTags = localStorage.getItem('warikan-sommelier-tags');
                if (savedTags) {
                    tags = JSON.parse(savedTags);
                } else {
                    tags = [
                        { name: "途中参加", rate: 0.8 },
                        { name: "途中帰宅", rate: 0.8 },
                        { name: "本日の主役", rate: 0.5 },
                        { name: "幹事割引", rate: 0.9 }
                    ];
                    saveTags();
                }
            }

            function saveTags() {
                localStorage.setItem('warikan-sommelier-tags', JSON.stringify(tags));
            }

            function renderTagManager() {
                const tagList = document.getElementById('tag-list');
                tagList.innerHTML = tags.map((tag, index) => `
                    <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                        <input type="text" value="${tag.name}" onchange="updateTagName(${index}, event.target.value)" class="form-input w-1/2 border-gray-300 rounded-md">
                        <input type="number" value="${tag.rate}" step="0.1" onchange="updateTagRate(${index}, event.target.value)" class="form-input w-1/4 border-gray-300 rounded-md">
                        <button onclick="deleteTag(${index})" class="text-red-500 hover:text-red-700">削除</button>
                    </div>
                `).join('');
            }
            
            window.updateTagName = (index, newName) => {
                tags[index].name = newName;
                saveTags();
            };
            window.updateTagRate = (index, newRate) => {
                tags[index].rate = parseFloat(newRate);
                saveTags();
            };
            window.deleteTag = (index) => {
                tags.splice(index, 1);
                saveTags();
                renderTagManager();
            };
            
            function addNewTag() {
                const nameInput = document.getElementById('modal-new-tag-name');
                const rateInput = document.getElementById('modal-new-tag-rate');
                const name = nameInput.value.trim();
                const rate = parseFloat(rateInput.value);
                if (name && !isNaN(rate)) {
                    tags.push({ name, rate });
                    saveTags();
                    renderTagManager();
                    nameInput.value = '';
                    rateInput.value = '';
                    document.getElementById('add-tag-modal').classList.add('hidden');
                } else {
                    alert('タグ名と掛率を正しく入力してください。');
                }
            }
            
            window.openTagSelectionModal = (member) => {
                const modal = document.getElementById('tag-selection-modal');
                const title = document.getElementById('tag-selection-title');
                const list = document.getElementById('tag-selection-list');
                const participant = state.stops[state.activeStopIndex].participants[member];

                title.textContent = `${member} さんのタグを選択`;
                list.innerHTML = tags.map(tag => `
                    <label class="flex items-center space-x-2 p-2 rounded-md bg-gray-100 cursor-pointer hover:bg-gray-200">
                        <input type="checkbox" value="${tag.name}" ${(participant.tags || []).includes(tag.name) ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>${tag.name} (x${tag.rate})</span>
                    </label>
                `).join('');
                
                document.getElementById('tag-selection-close-btn').onclick = () => {
                    const selectedTags = Array.from(list.querySelectorAll('input:checked')).map(input => input.value);
                    participant.tags = selectedTags;
                    modal.classList.add('hidden');
                    render();
                };
                
                modal.classList.remove('hidden');
            };
            
            // --- How to Use Modal ---
            function setupHowToUseModal() {
                const stepsContainer = document.getElementById('how-to-use-steps');
                const progressContainer = document.getElementById('how-to-use-progress');
                const steps = stepsContainer.children;
                
                progressContainer.innerHTML = Array.from(steps).map((_, i) => `<div class="h-2 w-2 rounded-full bg-gray-300 transition-colors duration-300 ${i === 0 ? 'bg-blue-600' : ''}"></div>`).join('');

                stepsContainer.addEventListener('scroll', () => {
                    const stepWidth = steps[0].offsetWidth;
                    const currentIndex = Math.round(stepsContainer.scrollLeft / stepWidth);
                    Array.from(progressContainer.children).forEach((dot, i) => {
                        dot.classList.toggle('bg-blue-600', i === currentIndex);
                        dot.classList.toggle('bg-gray-300', i !== currentIndex);
                    });
                });
            }

            // --- Settlement Status Functions ---
            window.showSettlementStatus = (id) => {
                const settlements = JSON.parse(localStorage.getItem('warikan-sommelier-history') || '[]');
                const settlement = settlements.find(s => s.id === id);
                if (!settlement) return;

                document.getElementById('settlement-status-title').textContent = `${settlement.eventDate} ${settlement.eventName} の清算状況`;
                const transactions = calculateOptimalSettlement(settlement);
                const listEl = document.getElementById('settlement-status-list');
                
                if (transactions.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-gray-600">精算は完了しています。</p>';
                } else {
                    listEl.innerHTML = transactions.map(t => {
                        const key = `${t.from}->${t.to}`;
                        const isChecked = settlement.settlementStatus && settlement.settlementStatus[key];
                        return `
                        <div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" onchange="updateSettlementStatus(${id}, '${key}', this.checked)" ${isChecked ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <div>
                                    <span class="font-medium ${isChecked ? 'text-gray-400 line-through' : ''}">${t.from} → ${t.to} : ${t.amount.toLocaleString()}円</span>
                                </div>
                            </label>
                            ${!isChecked ? `<button onclick="openReminderModal('${t.from}', '${t.to}', ${t.amount})" class="text-xs bg-orange-500 text-white px-2 py-1 rounded-md hover:bg-orange-600">リマインド</button>` : ''}
                        </div>`;
                    }).join('');
                }
                switchScreen('settlementStatus');
            };
            
            window.openReminderModal = (from, to, amount) => {
                reminderContext = { from, to, amount };
                selectTemplateTab(document.querySelector('.template-tab-btn.border-blue-500').dataset.template);
                templateModal.classList.remove('hidden');
            };

            window.updateSettlementStatus = (id, key, isChecked) => {
                let settlements = JSON.parse(localStorage.getItem('warikan-sommelier-history') || '[]');
                const settlement = settlements.find(s => s.id === id);
                if (settlement) {
                    if (!settlement.settlementStatus) settlement.settlementStatus = {};
                    settlement.settlementStatus[key] = isChecked;
                    localStorage.setItem('warikan-sommelier-history', JSON.stringify(settlements));
                    showSettlementStatus(id);
                }
            };
            
            function init() {
                loadTags();
                document.getElementById('new-settlement-btn').addEventListener('click', () => { resetState(); switchScreen('setup'); });
                document.getElementById('history-btn').addEventListener('click', () => { renderHistory(); switchScreen('history'); });
                document.getElementById('manage-tags-btn').addEventListener('click', () => { renderTagManager(); switchScreen('tagManager'); });
                document.getElementById('share-app-btn').addEventListener('click', shareApp);
                startBtn.addEventListener('click', startEvent);
                document.getElementById('back-to-home-btn-from-setup').addEventListener('click', () => switchScreen('home'));
                document.getElementById('back-to-home-btn-from-tags').addEventListener('click', () => switchScreen('home'));
                delimiterZenkakuBtn.addEventListener('click', () => setDelimiter('、'));
                delimiterHankakuBtn.addEventListener('click', () => setDelimiter(','));
                document.getElementById('back-to-home-btn-from-history').addEventListener('click', () => switchScreen('home'));
                document.getElementById('finalize-btn').addEventListener('click', showFinalSummary);
                document.getElementById('back-to-setup-btn').addEventListener('click', () => switchScreen('setup'));
                document.getElementById('screenshot-btn').addEventListener('click', takeScreenshot);
                document.getElementById('save-settlement-btn').addEventListener('click', saveSettlement);
                document.getElementById('back-to-edit-btn').addEventListener('click', () => switchScreen('event'));
                document.getElementById('copy-btn').addEventListener('click', () => {
                    reminderContext = null;
                    selectTemplateTab(document.querySelector('.template-tab-btn.border-blue-500').dataset.template || 'company'); 
                    templateModal.classList.remove('hidden'); 
                });
                document.getElementById('modal-close-btn').addEventListener('click', () => {
                    templateModal.classList.add('hidden');
                    reminderContext = null;
                });
                document.getElementById('error-modal-close-btn').addEventListener('click', () => document.getElementById('error-modal').classList.add('hidden'));
                document.getElementById('copy-confirm-btn').addEventListener('click', copyMessageToClipboard);
                document.querySelectorAll('.template-tab-btn').forEach(btn => btn.addEventListener('click', (e) => selectTemplateTab(e.target.dataset.template)));
                document.getElementById('show-add-tag-modal-btn').addEventListener('click', () => document.getElementById('add-tag-modal').classList.remove('hidden'));
                document.getElementById('add-tag-confirm-btn').addEventListener('click', addNewTag);
                document.getElementById('add-tag-cancel-btn').addEventListener('click', () => document.getElementById('add-tag-modal').classList.add('hidden'));
                document.getElementById('tag-selection-close-btn').addEventListener('click', () => document.getElementById('tag-selection-modal').classList.add('hidden'));
                document.getElementById('how-to-use-btn').addEventListener('click', () => {
                    document.getElementById('how-to-use-modal').classList.remove('hidden');
                    setupHowToUseModal();
                });
                document.getElementById('how-to-use-close-btn').addEventListener('click', () => document.getElementById('how-to-use-modal').classList.add('hidden'));
                document.getElementById('back-to-history-btn').addEventListener('click', () => switchScreen('history'));
                document.getElementById('back-to-home-btn-from-summary').addEventListener('click', () => switchScreen('home'));

                switchScreen('home');
            }
            init();
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>


